<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Available Guesthouses</title>
  <style>
    /* … your existing CSS … */
  </style>
</head>
<body>
  <h1>Available Guesthouses</h1>
  <div id="summaryBar">
    <div id="summaryText"></div>
    <button id="editBtn">Edit search</button>
  </div>
  <div id="filterPanel">
    <!-- … your filter controls … -->
    <button id="applyFilter">Apply</button>
  </div>
  <div id="results"></div>

  <script>
    let allHotels = [], islandsList = [];

    const summaryText = document.getElementById('summaryText');
    const filterPanel = document.getElementById('filterPanel');
    const editBtn     = document.getElementById('editBtn');
    const mini        = {
      island:    document.getElementById('islandFilter'),
      natRadios: document.getElementsByName('natFilter'),
      adults:    document.getElementById('adultsFilter'),
      kids:      document.getElementById('kidsFilter'),
      checkin:   document.getElementById('checkinFilter'),
      checkout:  document.getElementById('checkoutFilter'),
      suggestions: document.getElementById('suggestions-filter')
    };

    function updateSummary({island, nationality, adults, kids, checkin, checkout}) {
      summaryText.textContent =
        (island || 'All islands') + ' — ' +
        adults + ' adult(s), ' + kids + ' child(ren)' +
        (checkin ? ' — ' + checkin + ' → ' + checkout : '');
    }

    fetch('../dhathuru/data/guesthouse.json')
      .then(r => r.json())
      .then(data => {
        allHotels   = data.hotels;
        islandsList = [...new Set(allHotels.map(h => h.island))].sort();

        // read initial URL params
        const params = new URLSearchParams(window.location.search);
        const init = {
          island:      params.get('island')      || '',
          nationality: params.get('nationality') || 'Maldivian',
          adults:      params.get('adults')      || '1',
          kids:        params.get('kids')        || '0',
          checkin:     params.get('checkin')     || '',
          checkout:    params.get('checkout')    || ''
        };

        // set your filter UI to match init
        mini.island.value  = init.island;
        mini.adults.value  = init.adults;
        mini.kids.value    = init.kids;
        mini.checkin.value = init.checkin;
        mini.checkout.value= init.checkout;
        for (const r of mini.natRadios) {
          if (r.value === init.nationality) r.checked = true;
        }

        updateSummary(init);

        // ←—— HERE'S THE FIX: prefilter by island before rendering
        const initialHotels = init.island
          ? allHotels.filter(h =>
              h.island.toLowerCase() === init.island.toLowerCase()
            )
          : allHotels;

        renderResults(initialHotels, init);
      });

    editBtn.addEventListener('click', () => {
      filterPanel.style.display =
        filterPanel.style.display === 'block' ? 'none' : 'block';
    });

    // … your showSuggestions, applyFilter, etc. stay the same …

    document.getElementById('applyFilter').addEventListener('click', () => {
      const sel = {
        island:      mini.island.value,
        nationality: [...mini.natRadios].find(r => r.checked)?.value || 'Maldivian',
        adults:      mini.adults.value,
        kids:        mini.kids.value,
        checkin:     mini.checkin.value,
        checkout:    mini.checkout.value
      };
      updateSummary(sel);
      const filtered = allHotels.filter(h =>
        !sel.island ||
        h.island.toLowerCase() === sel.island.toLowerCase()
      );
      renderResults(filtered, sel);
      filterPanel.style.display = 'none';
    });

    function renderResults(hotels, filters) {
      const c = document.getElementById('results');
      c.innerHTML = '';
      if (!hotels.length) {
        c.innerHTML = '<p>No guesthouses found.</p>';
        return;
      }
      hotels.forEach(h => {
        const a = document.createElement('a');
        a.className = 'hotel-card';

        // build URL with all filter params
        const url = new URL('details.html', window.location.origin);
        url.searchParams.set('hotelId',     h.id);
        url.searchParams.set('island',      filters.island);
        url.searchParams.set('nationality', filters.nationality);
        url.searchParams.set('adults',      filters.adults);
        url.searchParams.set('kids',        filters.kids);
        url.searchParams.set('checkin',     filters.checkin);
        url.searchParams.set('checkout',    filters.checkout);
        a.href = url.toString();

        const rm    = h.rooms[0];
        const price = filters.nationality === 'Foreigner'
          ? rm.guestPrice
          : rm.localPrice;

        a.innerHTML = `
          <img src="${h.images[0]}" alt="${h.name}">
          <div class="hotel-card-content">
            <h2>${h.name}</h2>
            <p><strong>${rm.type}</strong> from $${price}/night</p>
            <p>Island: ${h.island}</p>
          </div>`;
        c.append(a);
      });
    }
  </script>
</body>
</html>
