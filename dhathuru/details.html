<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Guesthouse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --clr-bg: #f9fafb;
      --clr-accent: #4f46e5;
      --clr-border: #e5e7eb;
      --clr-text: #1f2937;
      --clr-input-bg: #ffffff;
      --clr-input-border: #d1d5db;
      --clr-shadow: rgba(0, 0, 0, 0.05);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--clr-bg);
      color:var(--clr-text);
      max-width:1000px;
      margin:2rem auto;
      padding:0 1rem;
      line-height:1.6;
    }
    h1 { text-align:center; font-size:1.75rem; margin-bottom:1rem; }

    /* Mini search bar */
    #summaryBar {
      background:#fff;
      padding:.75rem 1rem;
      border:1px solid var(--clr-border);
      border-radius:.5rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1rem;
    }
    #summaryText { font-size:.95rem; }
    #editBtn {
      background:var(--clr-input-bg);
      border:1px solid var(--clr-border);
      border-radius:.25rem;
      padding:.5rem 1rem;
      cursor:pointer;
    }

    /* Filter panel (hidden on this page) */
    #filterPanel { display:none; }

    /* Details and rooms */
    #details { display:grid; gap:1.5rem; }
    .hotel-info {
      background:#fff;
      padding:1rem;
      border:1px solid var(--clr-border);
      border-radius:.5rem;
    }
    .hotel-info img {
      width:100%;
      border-radius:.5rem;
      box-shadow:0 4px 8px var(--clr-shadow);
      margin-bottom:1rem;
    }
    .hotel-info p { margin:.5rem 0; }
    .rooms {
      background:#fff;
      padding:1rem;
      border:1px solid var(--clr-border);
      border-radius:.5rem;
    }
    .room {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.75rem;
    }
    .room-controls {
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .room-controls button {
      padding:.25rem .5rem;
      border:1px solid var(--clr-border);
      border-radius:.25rem;
      background:#fff;
      cursor:pointer;
    }
    /* ─── new: prettier card layout for each room ─── */
.room {                                   /* existing selector */
  flex-direction: column;                /* stack image + info */
  align-items: stretch;
  border: 1px solid var(--clr-border);
  border-radius: .5rem;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 2px 6px var(--clr-shadow);
  padding: 0;            /* image touches edges, info has padding */
}

.room img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.room-info { padding: .75rem 1rem; }
.room-info h3 { margin: 0 0 .25rem; font-size: 1.1rem; }
.room-info p { margin: .25rem 0; }

.room-controls { margin-top: .5rem; }     /* keep old buttons */

    #total {
      text-align:right;
      font-size:1.25rem;
      font-weight:600;
      margin-top:1rem;
    }
    #bookBtn {
      display:block;
      width:100%;
      padding:.75rem;
      background:var(--clr-accent);
      color:#fff;
      text-align:center;
      border:none;
      border-radius:.5rem;
      font-size:1rem;
      margin-top:1rem;
      text-decoration:none;
    }
    /* amenity pill strip */
#amenities {
  margin: .25rem 0 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}
#amenities span {
  background: #eef2ff;
  color: #4f46e5;
  font-size: .75rem;
  padding: .15rem .6rem;
  border-radius: .4rem;
  white-space: nowrap;
}
.transfer {
  background:#fff;
  padding:1rem;
  border:1px solid var(--clr-border);
  border-radius:.5rem;
  margin-top:1rem;
  font-weight:500;
}
.transfer label { cursor:pointer; }
.transfer input { margin-right:.5rem; accent-color:var(--clr-accent); }


  </style>
</head>
<body>
  <h1 id="hotelName">Loading…</h1>

  <div id="summaryBar">
    <div id="summaryText"></div>
    <button id="editBtn">Edit search</button>
  </div>
  <div id="filterPanel">
    <!-- hidden on this page -->
  </div>

  <div id="details">
    <div class="hotel-info">
      <img id="hotelImg" src="" alt="">
      <!-- new: amenity badges will be injected here -->
      <div id="amenities"></div>
      <p id="hotelDesc"></p>
    </div>
    <h2>Rooms types</h2>
    <div class="rooms" id="roomsContainer"></div>
  </div>

  <!-- ─── Transfer option ─── -->
<div id="transferBox" class="transfer" style="display:none;">
  <label>
    <input type="checkbox" id="transferToggle">
    YES! Include <span id="transferLabel"></span>
  </label>
</div>

<!-- contact + action (inside the same card where you show Total) -->
<input id="emailInput" type="email" placeholder="E-mail" required>
<input id="whatsInput" type="tel"   placeholder="WhatsApp (+country)" required>



  <div id="total">Total: $0.00</div>
  <button id="bookBtn">Book now</button>
  <p id="msg" style="margin-top:.4rem;color:#5a67d8;"></p>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    
    /* --------------------------------------------------
       Helpers
    -------------------------------------------------- */
    const ONE_DAY = 8.64e7;
    const nights  = (a,b)=>Math.round((new Date(b)-new Date(a))/ONE_DAY);
    const $       = id => document.getElementById(id);
    
    /* --------------------------------------------------
       Query-string params
    -------------------------------------------------- */
    const qs            = new URLSearchParams(location.search);
    const hotelId       = qs.get('hotelId');
    const island        = qs.get('island')      || '';
    const nationality   = qs.get('nationality') || 'Maldivian';
    const adults        = qs.get('adults')      || '1';
    const kids          = qs.get('kids')        || '0';
    const checkin       = qs.get('checkin')     || '';
    const checkout      = qs.get('checkout')    || '';
    const totalGuests   = +adults + +kids;
    
    /* mini-summary bar */
    $('summaryText').textContent =
      (island||'All islands') + ' — ' + adults + ' adult(s), ' + kids + ' child(ren)' +
      (checkin ? ' — ' + checkin + ' → ' + checkout : '');
    $('editBtn').onclick = () => location.href = 'results.html?' + location.search;
    
    /* state */
    let roomCounts = {}, currentHotel = null, includeTransfer = false;
    
    /* --------------------------------------------------
       Fetch JSON  → build page
    -------------------------------------------------- */
    fetch('../dhathuru/data/guesthouse.json')
      .then(r=>r.json())
      .then(data=>{
        currentHotel = data.hotels.find(h=>h.id === hotelId);
        if(!currentHotel){ alert('Hotel not found'); return; }
    
        /* top card */
        $('hotelName').textContent = currentHotel.name;
        $('hotelDesc').textContent = currentHotel.description;
        $('hotelImg').src          = currentHotel.images[0] || '';
    
        /* amenities */
        const amen = $('amenities'); amen.innerHTML='';
        (currentHotel.amenities||[]).forEach(a=>{
          const s = document.createElement('span'); s.textContent = a; amen.appendChild(s);
        });
    
        /* transfer box */
        if (currentHotel.transfer && currentHotel.transfer.type){
          const rate = nationality==='Foreigner'
              ? currentHotel.transfer.guestPrice
              : currentHotel.transfer.localPrice;
          $('transferLabel').textContent =
            `${currentHotel.transfer.type} transfer to ${currentHotel.island} ($${rate} pp)`;
          $('transferBox').style.display='block';
          $('transferToggle').onchange = e => { includeTransfer = e.target.checked; updateTotal(); };
        }
    
        /* room cards */
        const wrap = $('roomsContainer');
        currentHotel.rooms.forEach(rm=>{
          roomCounts[rm.type] = 0;
          const rate = nationality==='Foreigner' ? rm.guestPrice : rm.localPrice;
          const card = document.createElement('div');
          card.className='room';
          card.innerHTML = `
            <img src="${rm.image}" alt="${rm.type}">
            <div class="room-info">
              <h3>${rm.type}</h3>
              <p>${rm.description || ('Sleeps ' + rm.capacity)}</p>
              <p><strong>$${rate}</strong> / night</p>
              <div class="room-controls">
                <button data-type="${rm.type}" class="dec">−</button>
                <span id="count-${rm.type}">0</span>
                <button data-type="${rm.type}" class="inc">＋</button>
              </div>
            </div>`;
          wrap.appendChild(card);
        });
    
        /* + / − handlers */
        wrap.addEventListener('click',e=>{
          const btn=e.target, t = btn.dataset.type;
          if(!t) return;
          if(btn.classList.contains('inc')) roomCounts[t]++;
          else if(btn.classList.contains('dec') && roomCounts[t]>0) roomCounts[t]--;
          $('count-'+t).textContent = roomCounts[t];
          updateTotal();
        });
    
        /* first total */
        updateTotal();
      });
    
    /* --------------------------------------------------
       Total calculator
    -------------------------------------------------- */
    function updateTotal(){
      if(!currentHotel) return;
    
      /* capacity check */
      let beds = 0;
      currentHotel.rooms.forEach(r=> beds += roomCounts[r.type] * (r.capacity || 0));
      if(beds < totalGuests){
        $('total').textContent =
          `Select more rooms – current selection sleeps ${beds} but you have ${totalGuests} guest${totalGuests>1?'s':''}.`;
        return;
      }
    
      /* base cost */
      const stay = nights(checkin,checkout) || 1;
      let total  = 0;
      currentHotel.rooms.forEach(r=>{
        const rate = nationality==='Foreigner' ? r.guestPrice : r.localPrice;
        total += roomCounts[r.type] * rate * stay;
      });
    
      /* transfer cost */
      let tCost = 0;
      if(includeTransfer && currentHotel.transfer){
        const rate = nationality==='Foreigner'
          ? currentHotel.transfer.guestPrice
          : currentHotel.transfer.localPrice;
        tCost = rate * totalGuests; total += tCost;
      }
    
      let line = `Total for ${stay} night${stay>1?'s':''}: $${total.toFixed(2)}`;
      if(tCost) line += ` (includes transfer $${tCost.toFixed(2)})`;
      $('total').textContent = line;
    }
    
    /* --------------------------------------------------
       Send booking to Apps Script
    -------------------------------------------------- */
    $('bookBtn').addEventListener('click', async () => {
      const email = $('emailInput').value.trim();
      const whats = $('whatsInput').value.trim();
      const msg   = $('msg');
    
      if(!email || !whats){
        msg.style.color='crimson';
        msg.textContent = 'Please enter e-mail and WhatsApp.';
        return;
      }
    
      msg.style.color = '#5a67d8';
      msg.textContent = 'Sending…';
    
      const payload = {
        timestamp      : new Date().toISOString(),
        hotelId,
        hotelName      : currentHotel.name,
        island,
        nationality,
        adults,
        kids,
        checkin,
        checkout,
        rooms          : JSON.stringify(roomCounts),
        includeTransfer,
        transferType   : includeTransfer ? currentHotel.transfer.type : 'No',
        totalGuests,
        totalLine      : $('total').textContent,
        email,
        whatsapp       : whats
      };
    
      try {
        /* Google Apps-Script Web-app URL */
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxJKU9e1qVwoh1hTdU7ePFokyIQxtAycOr8HRnjqCV3qZ8j3Kp17yvlLHekOA9SY_Ab/exec';
    
        /* URL-encoded body (avoids CORS pre-flight) */
        const body = new URLSearchParams(payload).toString();
    
        const res = await fetch(scriptURL, {
          method : 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
    
        if (!res.ok) throw new Error(await res.text());
    
        msg.style.color = 'green';
        msg.textContent = 'Booking sucessfully sent We are checking avalibility and will whatsapp/email you with details within 12 hours';
        $('bookBtn').disabled = true;
    
      } catch (e) {
        msg.style.color = 'crimson';
        msg.textContent = 'Error: ' + e.message;
      }
    });
    
    }); // DOMContentLoaded
    </script>
    
    
    
</body>
</html>
